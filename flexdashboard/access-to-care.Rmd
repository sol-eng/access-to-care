---
title: "Access to Hospital Care Dashboard"
resource_files:
- config.yml
runtime: shiny
output:
  flexdashboard::flex_dashboard:
    logo: RStudio1.png
    navbar:
    - align: right
      href: https://solutions.rstudio.com/tour/access_to_care/
      title: About
    orientation: rows
    social:
    - linkedin
    - twitter
    - menu
    source_code: embed
    theme: lumen
---

```{r setup, include=FALSE}
library(flexdashboard)
library(dplyr)
library(purrr)
library(ggplot2)
library(leaflet)
library(DT)
library(usmap)
library(metricsgraphics)
library(pins)

if(Sys.getenv("R_CONFIG_ACTIVE") == "rsconnect") {
  boardname <- "rsconnect"
  board_register_rsconnect(
    server = Sys.getenv("connect_url"),
    key = Sys.getenv("connect_key")
    )
} else {
  boardname <- "local"
  board_register(boardname)  
}
```

```{r getdata, include=FALSE}
hospital_locations <- pin_get("edgar/atc-hospital-locations", board = boardname) 
county_shapes <- pin_get("edgar/atc_shapes", board = boardname)
county_hospitals <-  pin_get("edgar/atc-county_hospitals", board = boardname) %>%
  inner_join(statepop, by = c("state" = "abbr")) 
model <- pin_get("edgar/atc-model", board = boardname)
```

```{r, include=FALSE}
state_names <- county_hospitals %>%
  group_by(full) %>%
  summarise() %>%
  pull()

under <- "#CC79A7"
over <- "#0072B2"
at_level <- "#008b00"
hospital_color <- "#F0E442"
include <- c(-1, 1, 0)
add_hospitals <- 1

counties <- function(df, st, include) {
  df %>% 
    filter(full %in% st,
           result %in% include) %>%
    mutate(popup = paste0("<b>", county, "</b>",
                          "<br/>Population: ", prettyNum(population, big.mark = ","), 
                          "<br/>Hospitals: ", hospitals,
                          "<br/>Expected: ", fit
                          )) %>%  
    mutate(color = case_when(
      result ==  0  ~ at_level,
      result ==  1  ~ over,
      result == -1  ~ under)
      ) %>%
  #select(- county) %>%
  left_join(county_shapes, by = c("state", "county_key")) %>%
  filter(!is.na(county))
} 

state_data <- function(df, st, include) {
  df %>% 
    filter(full %in% st,
           result %in% include) 
  }
```


State Info
======================================================================


Row 
-----------------------------------------------------------------------
### Options

```{r}
selectInput(
  "state","Select a State:", state_names,
  selected="California", selectize = FALSE
  )
```


### Population

```{r}
renderValueBox({
  state_data(county_hospitals, input$state, include) %>%
    summarise(x = round(sum(population)/1000000, digits=0)) %>%
    mutate(x = paste0(prettyNum(x, big.mark = ","), "M") ) %>%
    pull(x) %>%
    valueBox(icon="fa-user")
    })
```

### Hospitals

```{r}
renderValueBox({
  state_data(county_hospitals, input$state, include) %>%
    summarise(sum(hospitals)) %>%
    pull() %>%
    valueBox(icon="fa-ambulance",color="#E69F00")
  })
```

### Counties

```{r}
renderValueBox({
  state_data(county_hospitals, input$state, include) %>%
    nrow() %>%
    valueBox(icon="fa-map-marker",color="#009E73")
  })
```


### Underserved Counties

```{r}
renderValueBox({
  state_data(county_hospitals, input$state, include) %>%
    filter(result == -1) %>%
    nrow() %>%
    valueBox(icon="fa-h-square", color="#CC79A7")
  })
```


Row {.tabset}
-----------------------------------------------------------------------

### County Map

Breakdown of counties and their status based on county population compared to the number of hospitals


```{r}

initial_map <- leaflet() %>%
  addProviderTiles(providers$CartoDB) %>%
  addLegend("bottomright", 
            color  = c(under,over ,at_level, hospital_color), 
            labels = c("Less hopitals than expected",
                       "More hospitals than expected", "Within Range", 
                       "Hospital Location"), 
            title  = "Legend",opacity = 0.5)


renderLeaflet({
county_map <- county_hospitals %>%
  counties(input$state, include)  %>%
  group_by(county_key, shape_id) %>%
  group_map(~.x) %>%
  reduce(
    ~ addPolygons(.x, 
                  lng = .y$long, 
                  lat = .y$lat, 
                  color = .y$color[[1]], 
                  popup = .y$popup[[1]],
                  weight = 1, fillOpacity = 0.3), 
    .init = initial_map)  
  
  if(add_hospitals == 1) {
    
    locations <- hospital_locations %>%
      inner_join(statepop, by = c("state" = "abbr")) %>%
      filter(full %in% input$state) %>%
      select(longitude, latitude) %>%
      mutate_all(round, 3) %>%
      count(longitude, latitude) %>%
      mutate(popup = paste0("Hospitals: ", n))
    
    county_map <- county_map %>%
      addCircleMarkers(
        lng = locations$longitude, 
        lat = locations$latitude,
        radius = 3 *locations$n,
        popup = locations$popup,
        fillColor = hospital_color, color = "gray", 
        fillOpacity = 0.7,weight = 1)
    } 
  county_map  
})
```

### County summary


```{r}
renderDataTable({
  state_data(county_hospitals, input$state, include) %>%
    select(county, population, hospitals, expected = fit) %>%
    datatable(class = 'cell-border stripe')
})
```

Model {.storyboard}
======================================================================

### There was a high degree of correlation between the county's population and the number of hospitals

```{r}
renderMetricsgraphics({
  county_hospitals %>%
    mutate(population = round(population / 1000)) %>%
    count(population, hospitals) %>%
    mjs_plot(x=population, y=hospitals, width=600, height=500) %>%
    mjs_point() %>%
    mjs_labs(x="Population (Thousands)", y="Hospitals")
})
```

### Fitted a model to predict how many hospitals should be in a county

```{r create-plot, eval = FALSE}
bounds <- county_hospitals %>%
  summarise(mi = min(population), mx = max(population)) %>%
  as.numeric()

preds <- predict(
  model, 
  data.frame(population = bounds),
  interval = "prediction")

set.seed(100)

county_hospitals %>% 
  ggplot() +
    geom_point(aes(hospitals, population), color = "#E69F00", alpha = 0.5) +
    scale_y_continuous(breaks = 0:10 * 1000000, labels = paste0(0:10, "M")) +
    geom_segment(x = preds[1,2], y = bounds[1],
                 xend = preds[2,2], yend = bounds[2],
                 color = "#009E73") +
    geom_segment(x = preds[1,3], y = bounds[1],
                 xend = preds[2,3], yend = bounds[2],
                 color = "#CC79A7") +
    theme_minimal()
```

```{r printplot}
knitr::include_graphics("model.png")

```


```{r}
sm <- summary(model)
```

***

The results of the model where:

- Multiple R-squared:  `r sm$r.squared`

- Adjusted ***R-squared:  `r sm$adj.r.squared` ***

And the formula was: 

- lm(formula = hospitals ~ population)


