---
title: "Access to Care Analysis"
output: html_notebook
---

```{r, include = FALSE}
library(tidyverse)
library(rlang)
library(leaflet)
```

```{r, eval = FALSE}
library(tidyverse)
library(rlang)
library(leaflet)
```

```{r, echo = FALSE}
hospitals <- read_csv("../data/hospital_list.csv")
```


```{r}

hospitals
```

```{r}
hospital_locations <- hospitals  %>%
  select(state, longitude, latitude)
write_rds(hospital_locations, "../data/hospital_locations.rds")
hospital_locations
```

```{r}
population <- usmap::countypop

hospital_count <- hospitals %>%
  count(state, original_county) 


state_hospitals <- population %>%
  left_join(hospital_count, by = c("abbr" = "state", "county" = "original_county")) %>%
  mutate(hospitals = ifelse(is.na(n), 0, n)) %>%
  select(
    fips, 
    state = abbr, 
    county, 
    population = pop_2015,
    hospitals
    )

state_hospitals
```




```{r}
set.seed(100)

hospital_sample <- state_hospitals %>%
  sample_frac(0.3)

hospital_sample
```

```{r}
model <- lm(hospitals ~ population, data = hospital_sample)
write_rds(model, "../data/model.rds")
summary(model)
```

```{r}
predictions <- predict(model, 
  newdata = state_hospitals, 
  interval = "prediction") %>%
  as_tibble() %>%
  mutate_all(round)

predictions
```

```{r}
hospital_results <- state_hospitals %>%
  bind_cols(predictions) %>%
  mutate(result = case_when(
    hospitals < lwr ~ -1,
    hospitals > upr ~ 1,
    TRUE ~ 0)) %>%
  mutate(
    county_key = str_remove_all(county, " County"),
    county_key = str_remove_all(county_key, " Parish"),
    county_key = str_remove_all(county_key, " city"),
    county_key = str_to_lower(county_key),
    county_key = str_remove_all(county_key, " "),
    county_key = str_replace_all(county_key, "st. ", "saint"),
      )  

write_rds(hospital_results, "../data/hospitals.rds")

hospital_results 
```

## State map

```{r}
shapes <- read_rds("../data/shapes.rds") %>%
  mutate(
    county_key = str_to_lower(county),
    county_key = str_remove_all(county_key, " "),
    county_key = str_replace_all(county_key, "st. ", "saint")
  ) 

shapes 
```
```{r}
county_hospitals <- hospital_results  %>%
  select(- county) %>%
  left_join(shapes, by = c("state", "county_key")) %>%
  filter(state != "PR", state != "AK") %>%
  filter(!is.na(county))

write_rds(county_hospitals, "../data/county_hospitals.rds", compress = "gz")

county_hospitals
```

```{r}
library(fs)

path("..","data", c("county_hospitals.rds", "hospital_locations.rds", "model.rds")) %>%
  file_copy("../flexdashboard", overwrite = TRUE)

path("..","data", c("county_hospitals.rds", "hospital_locations.rds", "model.rds")) %>%
  file_copy("../presentation", overwrite = TRUE)

path("..","data", c("county_hospitals.rds", "hospital_locations.rds")) %>%
  file_copy("../RMarkdown-html", overwrite = TRUE)

path("..","data", c("county_hospitals.rds", "hospital_locations.rds")) %>%
  file_copy("../RMarkdown-pdf", overwrite = TRUE)

path("..","data", c("model.rds", "hospitals.rds", "hospital_locations.rds")) %>%
  file_copy("../plumber-api", overwrite = TRUE)

path("..","data", c("model.rds", "county_hospitals.rds")) %>%
  file_copy("../powerpoint", overwrite = TRUE)

path("..","data", c("model.rds", "county_hospitals.rds")) %>%
  file_copy("../powerpoint-state", overwrite = TRUE)


```

