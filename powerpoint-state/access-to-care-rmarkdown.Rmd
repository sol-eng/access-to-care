---
title: "Access to Care"
params:
  printcode:
    label: 'Display Code:'
    value: no
  state:
    choices:
    - Alabama
    - Alaska
    - Arizona
    - Arkansas
    - California
    - Colorado
    - Connecticut
    - Delaware
    - District of Columbia
    - Florida
    - Georgia
    - Hawaii
    - Idaho
    - Illinois
    - Indiana
    - Iowa
    - Kansas
    - Kentucky
    - Louisiana
    - Maine
    - Maryland
    - Massachusetts
    - Michigan
    - Minnesota
    - Mississippi
    - Missouri
    - Montana
    - Nebraska
    - Nevada
    - New Hampshire
    - New Jersey
    - New Mexico
    - New York
    - North Carolina
    - North Dakota
    - Ohio
    - Oklahoma
    - Oregon
    - Pennsylvania
    - Rhode Island
    - South Carolina
    - South Dakota
    - Tennessee
    - Texas
    - Utah
    - Vermont
    - Virginia
    - Washington
    - West Virginia
    - Wisconsin
    - Wyoming
    input: select
    label: 'State:'
    value: California
resource_files:
- template.potx
output:
  powerpoint_presentation:
    reference_doc: template.potx
---

<img src="RStudio1.png" style="position:absolute;top:10px;right:200px;" />

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = params$printcode)

library(rmarkdown)
library(blastula)
library(ggplot2)
library(formattable)
library(dplyr)
library(purrr)
library(ggplot2)
library(leaflet)
library(DT)
library(usmap)
library(metricsgraphics)
library(pins)

boardname <- config::get("boardname")
if(boardname != "local") {
  board_register(boardname, server = config::get("server"), key = config::get("key")
  )
} else {
  board_register("local")  
}
hospital_locations <- pin_get("edgar/atc-hospital-locations", board = boardname) 
county_shapes <- pin_get("edgar/atc_shapes", board = boardname)
county_hospitals <-  pin_get("edgar/atc-county_hospitals", board = boardname) %>%
  inner_join(statepop, by = c("state" = "abbr")) 

state_names <- county_hospitals %>%
  group_by(full) %>%
  summarise() %>%
  pull()

under <- "#CC79A7"
over <- "#0072B2"
at_level <- "#008b00"
hospital_color <- "#F0E442"
include <- c(-1, 1, 0)
add_hospitals <- 1

counties <- county_hospitals %>% 
    filter(full %in% params$state,
           result %in% include) %>%
    mutate(popup = paste0("<b>", county, "</b>",
                          "<br/>Population: ", prettyNum(population, big.mark = ","), 
                          "<br/>Hospitals: ", hospitals,
                          "<br/>Expected: ", fit
                          )) %>%  
    mutate(color = case_when(
      result ==  0  ~ at_level,
      result ==  1  ~ over,
      result == -1  ~ under
    )) %>%
  select(- county) %>%
  left_join(county_shapes, by = c("state", "county_key")) %>%
  filter(!is.na(county))


```

# `r params$state`

## Background

We are trying to determine which counties in **`r params$state`** have comparatively more access or less access to hospital care.

A **statistical model using data from across the country** is used to identify those counties that have more or less than the model expects the specific county to have.

## County Map

```{r, fig.width = 10, fig.height = 6}

cts_map <- counties %>%
  mutate(group = paste(county, shape_id)) %>%
  ggplot() +
  geom_polygon(
    aes(long, lat, group = group), 
    fill = counties$color,
    alpha = 0.7,
    color = "#666666") +
  theme_minimal() +
  theme(
    axis.title = element_blank(), 
    axis.text = element_blank(), 
    panel.grid = element_blank(),
    panel.grid.major = element_blank()) 

cts_map
```


## County Data
Counties with above or below the number of hostpitals expected.
```{r}
display_table <- counties %>%
  select(county, population,hospitals, fit, result) %>%
  mutate(result = case_when(
      result ==  0  ~ "Acceptable",
      result ==  1  ~ "Above",
      result == -1  ~ "Under"
    )) %>%
  mutate(
    population = ifelse(
      population > 1000000, 
      paste0(round(population / 1000000), "M"),
      paste0(round(population / 1000), "K")
      )) %>%
  rename(
    County = county,
    Population = population,
    Hospitals = hospitals,
    Expected = fit,
    `Model Result` = result
    ) 

display_table %>%
  filter(`Model Result` != "Acceptable") 
```

