---
title: "Access to Care by State"
params:
  printcode:
    label: 'Display Code:'
    value: no
  state:
    choices: [Alabama, Arizona, Arkansas, California, Colorado, Connecticut, Delaware, District of Columbia, Florida, Georgia, Hawaii, Idaho, Illinois, Indiana, Iowa, Kansas, Kentucky, Louisiana, Maine, Maryland, Massachusetts, Michigan, Minnesota, Mississippi, Missouri, Montana, Nebraska, Nevada, New Hampshire, New Jersey, New Mexico, New York, North Carolina, North Dakota, Ohio, Oklahoma, Oregon, Pennsylvania, Puerto Rico, Rhode Island, South Carolina, South Dakota, Tennessee, Texas, Utah, Vermont, Virginia, Washington, West Virginia, Wisconsin, Wyoming]
    input: select
    label: 'State:'
    value: California
output:
  html_document:
    css: custom-style.css
---

```{r, include=FALSE}
knitr::opts_chunk$set(echo = params$printcode)

library(accesstocare)
library(blastula)
library(dplyr)
library(DT)
library(gt)
```

## `r params$state`

### Background

This report analyzes hospital access across counties in **`r params$state`**. The goal is to identify which counties may be underserved or overserved relative to their population size.

Our analysis uses a **statistical model built on nationwide data** that predicts the expected number of hospitals for a county based on its population. By comparing actual hospital counts to model predictions, we can identify counties that fall outside expected ranges. Counties with fewer hospitals than the model's minimum prediction are flagged as potentially underserved.

The data sources for this analysis include hospital locations from the Centers for Medicare & Medicaid Services (2025) and population estimates from the U.S. Census Bureau (2024).

### County Map

The map below shows each county in **`r params$state`** color-coded by its model status. Counties are classified as:

- **Below**: Fewer hospitals than expected (potentially underserved)
- **At Level**: Hospital counts within expected range
- **Above**: More hospitals than expected

```{r, fig.height = 7, fig.width = 9}
atc_plot_state_map(state = params$state)
```

### County Data

The table below provides detailed data for each county in **`r params$state`**. This includes population estimates, actual hospital counts, model predictions, and whether a county is identified as underserved.

```{r}
state_info <- us_counties |>
  filter(state_name == params$state)

state_info |>
  mutate(underserved = ifelse(pred_status == "below", "Yes", "")) |>
  select(county_name, population, hospitals, pred_fit, pred_lwr, underserved) |>
  datatable(
    colnames = c(
      "County" = "county_name",
      "Population" = "population",
      "Hospitals" = "hospitals",
      "Expected" = "pred_fit",
      "Minimum" = "pred_lwr",
      "Underserved" = "underserved"
    ),
    options = list(pageLength = 25)
  )
```

**Column Definitions:**

- **County**: The name of the county
- **Population**: Estimated population for the county (U.S. Census Bureau, 2024)
- **Hospitals**: The actual number of hospitals currently operating in the county
- **Expected**: The expected number of hospitals predicted by the statistical model based on population
- **Minimum**: The lower bound of the model's prediction interval. Counties below this threshold are considered underserved
- **Underserved**: Marked as "Yes" if the county has fewer hospitals than the minimum expected threshold, indicating potential gaps in healthcare access

```{r, echo = FALSE, eval = TRUE}
pred_status <- state_info |> 
  pull(pred_status)

# Email is only sent if there are counties below the expected number as per
# the model

if("below" %in% pred_status) {
  attach_connect_email(
  render_connect_email("email/access-to-care-email.Rmd"),
  subject = paste0("Access to Care - ", params$state)
)
}

```
