---
title: "Access to Hospital Care Dashboard"
runtime: shiny_prerendered
output:
  flexdashboard::flex_dashboard:
    logo: images/RStudio1.png
    navbar:
    - align: right
      href: https://solutions.rstudio.com/tour/access_to_care/
      title: About
    orientation: rows
    social:
    - linkedin
    - twitter
    - menu
    source_code: embed
    theme: lumen
---

```{r setup, include = FALSE}
library(flexdashboard)
library(accesstocare)
library(ggplot2)
library(ggiraph)
library(usmap)
library(dplyr)
library(shiny)
library(rlang)
library(gt)

state_list <- c("All US", us_states$state_name)

county_map <- usmap::us_map("county")

```


State Info
======================================================================


Row 
-----------------------------------------------------------------------

### Options


```{r}
selectInput(
  inputId = "state",
  label = "Select a State:",
  choices = state_list,
  selected = "All US", 
  selectize = FALSE
  )
```

### Population

```{r}
valueBoxOutput("population")
```

### Hospitals

```{r}
valueBoxOutput("hospitals")
```

### Counties

```{r}
valueBoxOutput("counties")
```

### Underserved Counties

```{r}
valueBoxOutput("underserved")
```

Row {data-height=1050}
-----------------------------------------------------------------------

###  Map

```{r}
actionButton(
  inputId = "us",
  label = "All US"
  )

radioButtons(
  inputId = "view",
  label = "Select a view:",
  choices = c("Hospitals per Capita", "No. of Hospitals", "Population"), 
  inline = TRUE
  )
```

```{r, fig.width=5, fig.height=5, eval = TRUE}
girafeOutput("usmap")
```

```{r, context = "server"}

observeEvent(input$usmap_selected, {
  sel_map <- input$usmap_selected
  if(any(sel_map == state_list)) {
    updateSelectInput(session, "state", selected = sel_map)
  } else {
    sel_county <- us_hospitals %>% 
      filter(fips == sel_map) 
    
    showModal(modalDialog(
      title = sel_county$county_name[1],
      sel_county %>% 
        arrange(facility_name, city) %>%
        mutate(nbr = row_number()) %>% 
        select(nbr, facility_name, city) %>% 
        gt() %>% 
        cols_label(
          nbr = "",
          facility_name = "Hospital Name",
          city = "City"
        ),
      easyClose = TRUE, fade = TRUE
    ))
  }
})

observeEvent(
  input$us, 
  updateSelectInput(session, "state", selected = "All US")
  )

output$usmap <- renderGirafe({
  
  x_width <- 10
  
  if(input$view == "Hospitals per Capita") vr <- "per-capita"
  if(input$view == "Population") vr <- "population"
  if(input$view == "No. of Hospitals") vr <- "hospitals"
    
  if(input$state == "All US") {
    gp <- atc_plot_us_map(vr)
  } else {
    
    state_polygons <- county_map %>% 
      filter(full == input$state)
    
    x_width <- state_polygons %>% 
      summarise(
        max_x = max(x),
        min_x = min(x),
        max_y = max(y),
        min_y = min(y)
      ) %>% 
      mutate(
        x_size = max_x - min_x,
        y_size = max_y - min_y,
        xy = x_size/y_size * 10
      ) %>% 
      pull(xy)
    
    gp <- atc_plot_state_map(input$state)
  }
  
  girafe(
    ggobj = gp,
    width = x_width, 
    height = 5,
    options = list(
      opts_selection(type = "single", only_shiny = FALSE),
      opts_tooltip(opacity = 0.7)
      )
    )  
})

sel_state <- reactive({
  if(input$state == "All US") {
    us_states
  } else {
    us_states %>% 
      filter(state_name == input$state) 
  }
})

sel_county <- reactive({
  if(input$state == "All US") {
    us_counties
  } else {
    us_counties %>% 
      filter(state_name == input$state) 
  }
})

output$population <- renderValueBox({
  sel_state() %>% 
    summarise(sum(population)) %>% 
    pull() %>%
    format_number() %>% 
    valueBox(icon="fa-user")
    })

output$hospitals <- renderValueBox({
  sel_state() %>%
    summarise(sum(hospitals)) %>%
    pull() %>% 
    format_number() %>% 
    valueBox(icon="fa-ambulance",color="#E69F00")
  })

output$counties <- renderValueBox({
  sel_county() %>%
    count() %>% 
    pull() %>% 
    format_number() %>% 
    valueBox(icon="fa-map-marker",color = palette_atc$above)
  })

output$underserved <- renderValueBox({
  sel_county() %>%
    filter(pred_status == "below") %>% 
    count() %>% 
    pull() %>% 
    valueBox(icon="fa-h-square", color = palette_atc$below)
  })
```

