---
title: "Access to Hospital Care Dashboard"
runtime: shiny
output:
  flexdashboard::flex_dashboard:
    logo: RStudio1.png
    navbar:
    - align: right
      href: https://solutions.rstudio.com/tour/access_to_care/
      title: About
    orientation: rows
    social:
    - linkedin
    - twitter
    - menu
    source_code: embed
    theme: lumen
---

```{r setup, include = FALSE}
library(flexdashboard)
library(accesstocare)
library(ggplot2)
library(ggiraph)
library(usmap)
library(dplyr)
library(shiny)
library(rlang)

state_list <- c("All US", us_states$state_name)

sel_state <- reactive({
  if(input$state == "All US") {
    us_states
  } else {
    us_states %>% 
      filter(state_name == input$state) 
  }
})

sel_county <- reactive({
  if(input$state == "All US") {
    us_counties
  } else {
    us_counties %>% 
      filter(state_name == input$state) 
  }
})
  
under <- "#CC79A7"
over <- "#0072B2"  #009E73
at_level <- "#008b00"
```


State Info
======================================================================


Row 
-----------------------------------------------------------------------

### Options


```{r}
selectInput(
  inputId = "state",
  label = "Select a State:",
  choices = state_list,
  selected = "All US", 
  selectize = FALSE
  )
```

### Population

```{r}
renderValueBox({
  sel_state() %>% 
    summarise(sum(population)) %>% 
    pull() %>%
    format_number() %>% 
    valueBox(icon="fa-user")
    })
```

### Hospitals

```{r}
renderValueBox({
  sel_state() %>%
    summarise(sum(hospitals)) %>%
    pull() %>% 
    format_number() %>% 
    valueBox(icon="fa-ambulance",color="#E69F00")
  })
```

### Counties

```{r}
renderValueBox({
  sel_county() %>%
    count() %>% 
    pull() %>% 
    format_number() %>% 
    valueBox(icon="fa-map-marker",color = over)
  })
```

### Underserved Counties

```{r}
renderValueBox({
  sel_county() %>%
    filter(pred_status == "below") %>% 
    count() %>% 
    pull() %>% 
    valueBox(icon="fa-h-square", color = under)
  })
```

Row {data-height=1050}
-----------------------------------------------------------------------

### Selection

```{r}
radioButtons(
  inputId = "view",
  label = "Select a view:",
  choices = c("Hospitals per Capita", "No. of Hospitals", "Population")
  )
```


###  Map

```{r, fig.width=12, fig.height=5, eval = TRUE}
output$usmap <- renderGirafe({
  
  low_color <- "#eeeeee"
  high_color <- over
  
  if(input$view == "Hospitals per Capita") {
    vr <- "per_person"
    low_color <- over
    high_color <- "#eeeeee"
  }  
  if(input$view == "Population") vr <- "population"
  if(input$view == "No. of Hospitals") vr <- "hospitals"
    
  gp <- us_states %>% 
    mutate(
      pop = format_number(population),
      tooltip = paste0(state_name, "\nPopulation: ", pop, "\nHospitals: ", format_number(hospitals))
      ) %>% 
    mutate(fill = !! sym(vr)) %>% 
    select(state, fill, tooltip) %>% 
    inner_join(us_hex_polygons, by = "state") %>% 
    ggplot() +
    geom_polygon_interactive(aes(x, y, group = state, fill = fill, data_id = state, tooltip = tooltip), color = "#333333") +
    geom_text_interactive(aes(x, y, label = state, data_id = state), size = 20, data = us_hex_positions) +
    scale_fill_gradient(low = low_color, high = high_color) +
    theme_void() +
    theme(legend.position = "none")
  
  girafe(
    ggobj = gp,
    width = 50, height = 25,
    options = list(
      opts_selection(type = "single", only_shiny = FALSE),
      opts_tooltip(opacity = 0.7)
      )
    )  
})

girafeOutput("usmap")
```

